#!/usr/bin/env sh

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo ""
echo "${CYAN}============================================${NC}"
echo "${CYAN}   Devometric Community Edition${NC}"
echo "${CYAN}   AI Adoption Coach for Engineering Teams${NC}"
echo "${CYAN}============================================${NC}"
echo ""

# Check for foreman
if ! gem list foreman -i --silent; then
  echo "${YELLOW}Installing foreman...${NC}"
  gem install foreman
fi

# Default to port 3000 if not specified
export PORT="${PORT:-3000}"

# Let the debug gem allow remote connections,
# but avoid loading until `debugger` is called
export RUBY_DEBUG_OPEN="true"
export RUBY_DEBUG_LAZY="true"

# Check if database exists and is migrated
echo "${BLUE}Checking database status...${NC}"
if ! bin/rails db:version > /dev/null 2>&1; then
  echo "${YELLOW}Database not set up. Running setup...${NC}"
  bin/rails db:setup
  echo "${GREEN}Database ready with sample data!${NC}"
else
  # Check for pending migrations
  if bin/rails db:migrate:status 2>/dev/null | grep -q "down"; then
    echo "${YELLOW}Running pending migrations...${NC}"
    bin/rails db:migrate
  fi
fi

echo ""
echo "${GREEN}Starting development server...${NC}"
echo ""
echo "${BLUE}Home:${NC}          http://localhost:${PORT}"
echo "${BLUE}Chat Demo:${NC}     http://localhost:${PORT}/demo"
echo "${BLUE}Widget Test:${NC}   http://localhost:${PORT}/test-widget.html"
echo "${BLUE}API Docs:${NC}      docs/API_SPECIFICATION.md"
echo ""
echo "${CYAN}-------------------------------------------${NC}"
echo "${CYAN}Community Edition - MIT License${NC}"
echo "${CYAN}Contributions welcome!${NC}"
echo "${CYAN}https://github.com/Devometric/devometric-platform${NC}"
echo "${CYAN}-------------------------------------------${NC}"
echo ""

exec foreman start -f Procfile.dev "$@"
